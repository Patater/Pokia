<!DOCTYPE html>
<html>
<head>
<title>Pokia</title>
<meta charset="UTF-8">
</head>
<body>

<img src="Nokia_1100.jpg" width="400">

<script>
Note = function() {
  this.frequency = RTTTL.NOTE_C4;

  this.duration = RTTTL.QUARTER_NOTE;

  // If this is true, then frequency will be ignored and we'll "rest" instead
  // of playing for the specified duration.
  this.pause = false;
}

RTTTL = function() {
  // http://merwin.bespin.org/t4a/specs/nokia_rtttl.txt
  this.defaultOctave = 6;
  this.defaultDuration = 4;
  this.defaultTempo = 63;

  this.song = [];
}

RTTTL.prototype.parse = function(rtttl) {
  var colonTokens = rtttl.split(":");
  this.name = colonTokens[0];
  this.parseDefaults(colonTokens[1]);
  this.parseSong(colonTokens[2]);
}

RTTTL.prototype.parseDefaults = function(defaults) {
  var commaTokens = defaults.split(",");
  for (var i = 0; i < commaTokens.length; i++) {
    if (commaTokens[i][0] == "o") {
      this.defaultOctave = parseInt(commaTokens[i].substring(2), 10);
    } else if (commaTokens[i][0] == "d") {
      this.defaultDuration = parseInt(commaTokens[i].substring(2), 10);
    } else if (commaTokens[i][0] == "b") {
      this.defaultTempo = parseInt(commaTokens[i].substring(2), 10);
    }
  }
}

RTTTL.prototype.parseSong = function(song) {
  var commaTokens = song.split(",");
  for (var i = 0; i < commaTokens.length; i++) {
    this.parseNote(commaTokens[i]);
  }
}

RTTTL.prototype.parseNote = function(note) {
  var noteToAdd = new Note();
  var passedNote = false;
  var regexNum = /\d/;
  var regexNote = /[PCDEFGAB#]/;
  var regexDot = /./;
  var i = 0;
  var start = 0;
  // Until we reach a non-digit
  while (regexNum.test(note.charAt(i))) {
    i++;
  }
  // i may point to the first non-digit or the beginning of the string
  var duration = note.substring(start, i);
  start = i;
  if (duration != "") {
    noteToAdd.duration = parseInt(note.substring(0, i), 10);
  } else {
    noteToAdd.duration = this.defaultDuration;
  }
  //
  // Until we reach a non-note
  while (regexNote.test(note.charAt(i))) {
    i++;
  }
  // i needs to point to the end of a note
  var whichNote = note.substring(start, i);
  start = i;
  // Until we reach a non-dot
  while (regexDot.test(note.charAt(i))) {
    i++;
  }
  // i must point to the end of the note text
  var octave = note.substring(start, i);
  if (!regexNum.test(octave)) {
    octave = this.defaultOctave;
  }
  if (whichNote == "P")
  {
    noteToAdd.pause = true;
  } else if (whichNote == "C") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_C5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_C6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_C7;
    }
  } else if (whichNote == "C#") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_CS5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_CS6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_CS7;
    }
  } else if (whichNote == "D") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_D5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_D6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_D7;
    }
  } else if (whichNote == "D#") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_DS5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_DS6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_DS7;
    }
  } else if (whichNote == "E") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_E5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_E6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_E7;
    }
  } else if (whichNote == "F") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_F5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_F6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_F7;
    }
  } else if (whichNote == "F#") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_FS5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_FS6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_FS7;
    }
  } else if (whichNote == "G") {
      noteToAdd.pause = true; // A4 is the lowest note.
    if (octave == "4") {
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_G5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_G6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_G7;
    }
  } else if (whichNote == "G#") {
    if (octave == "4") {
      noteToAdd.pause = true; // A4 is the lowest note.
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_GS5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_GS6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_GS7;
    }
  } else if (whichNote == "A") {
    if (octave == "4") {
      noteToAdd.frequency = RTTTL.NOTE_A4;
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_A5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_A6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_A7;
    }
  } else if (whichNote == "A#") {
    if (octave == "4") {
      noteToAdd.frequency = RTTTL.NOTE_AS4;
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_AS5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_AS6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_AS7;
    }
  } else if (whichNote == "B") {
    if (octave == "4") {
      noteToAdd.frequency = RTTTL.NOTE_B4;
    } else if (octave == "5") {
      noteToAdd.frequency = RTTTL.NOTE_B5;
    } else if (octave == "6") {
      noteToAdd.frequency = RTTTL.NOTE_B6;
    } else if (octave == "7") {
      noteToAdd.frequency = RTTTL.NOTE_B7;
    }
  }

  if (note.charAt(i) == ".") {
    noteToAdd.duration *= RTTTL.DOT;
  }

  this.song.push(noteToAdd);
}

RTTTL.prototype.play = function(when) {
  var beatLength = 4.0 * 60.0 / 220.0;
  var then = when;
  for (var i = 0; i < this.song.length; i++) {
    var note = this.song[i];
    var duration = beatLength / note.duration;
    if (!note.pause) {
      beep(then, note.frequency, duration);
    }
    then += duration;
  }
}

RTTTL.prototype.pause = function() {
}

// http://www.phy.mtu.edu/~suits/notefreqs.html
RTTTL.NOTE_A3 = 220;
RTTTL.NOTE_AS3 = 233.08;
RTTTL.NOTE_B3 = 246.94;
RTTTL.NOTE_C4 = 261.63;
RTTTL.NOTE_CS4 = 277.18;
RTTTL.NOTE_D4 = 293.66;
RTTTL.NOTE_DS4 = 311.13;
RTTTL.NOTE_E4 = 329.63;
RTTTL.NOTE_F4 = 349.23;
RTTTL.NOTE_FS4 = 369.99;
RTTTL.NOTE_G4 = 392.00;
RTTTL.NOTE_GS4 = 415.30;
RTTTL.NOTE_A4 = 440.00; // A1 Nokia Composer
RTTTL.NOTE_AS4 = 466.16;
RTTTL.NOTE_B4 = 493.88;
RTTTL.NOTE_C5 = 523.25;
RTTTL.NOTE_CS5 = 554.37;
RTTTL.NOTE_D5 = 587.33;
RTTTL.NOTE_DS5 = 622.25;
RTTTL.NOTE_E5 = 659.26;
RTTTL.NOTE_F5 = 698.46;
RTTTL.NOTE_FS5 = 739.99;
RTTTL.NOTE_G5 = 783.99;
RTTTL.NOTE_GS5 = 830.61;
RTTTL.NOTE_A5 = 880.00;
RTTTL.NOTE_AS5 = 932.33;
RTTTL.NOTE_B5 = 987.77;
RTTTL.NOTE_C6 = 1046.50;
RTTTL.NOTE_CS6 = 1108.73;
RTTTL.NOTE_D6 = 1174.66;
RTTTL.NOTE_DS6 = 1244.51;
RTTTL.NOTE_E6 = 1318.51;
RTTTL.NOTE_F6 = 1396.91;
RTTTL.NOTE_FS6 = 1479.98;
RTTTL.NOTE_G6 = 1567.98;
RTTTL.NOTE_GS6 = 1661.22;
RTTTL.NOTE_A6 = 1760.00;
RTTTL.NOTE_AS6 = 1864.66;
RTTTL.NOTE_B6 = 1975.53;
RTTTL.NOTE_C7 = 2093.00;
RTTTL.NOTE_CS7 = 2217.46;
RTTTL.NOTE_D7 = 2349.32;
RTTTL.NOTE_DS7 = 2489.02;
RTTTL.NOTE_E7 = 2637.02;
RTTTL.NOTE_F7 = 2793.83;
RTTTL.NOTE_FS7 = 2959.96;
RTTTL.NOTE_G7 = 3135.96;
RTTTL.NOTE_GS7 = 3322.44;
RTTTL.NOTE_A7 = 3520.00;
RTTTL.NOTE_AS7 = 3729.31;
RTTTL.NOTE_B7 = 3951.07;

RTTTL.WHOLE_NOTE = 1;
RTTTL.HALF_NOTE = 2;
RTTTL.QUARTER_NOTE = 4;
RTTTL.EIGHTH_NOTE = 8;
RTTTL.SIXTEENTH_NOTE = 16;
RTTTL.THIRTY_SECOND_NOTE = 32;
RTTTL.DOT = 1.5;

var context;
var squarewave;
var globalGain;
var songGain;
window.addEventListener('load', init, false);
function init() {
  try {
    context = new webkitAudioContext();
  } catch(e) {
    alert(
      "Web Audio API is not supported in this browser.\n\nWhy aren't you" +
      "using Google Chrome yet?"
    );
    return;
  }
  squarewave = context.createOscillator();
  squarewave.type = squarewave.SQUARE;
  globalGain = context.createGainNode();
  globalGain.gain.value = 0.1;

  songGain = context.createGainNode();
  songGain.gain.value = 0;

  squarewave.connect(songGain);
  songGain.connect(globalGain);
  globalGain.connect(context.destination);

  squarewave.noteOn(0);

  //playNokia(0);
  rtttl = new RTTTL();
  rtttl.parse("nokia:o=5,d=8,b=220:E6,D6,4F#,4G#,C#6,B,4D,4E,B,A,4C#,4E,2A.");

  // Nokia Composer Nyan Cat
  // http://www.youtube.com/watch?v=eMD6hThdFFo
  // 8#f3 8#g3 16#c3 8#d3 16#c3 16d3 16#c3 8b2 8b2 8#c3 8d3 16d3 16#c3 16b2
  // 16#c3 16#d3 16#f3 16#g3 16#d3 16#f3 16#c3 16#d3 16b2 16#c3 16b2 8#d3 8#f3
  // 16#g3 16#d3 16#f3 16#c3 16#d3 16b2 16#c3 16#d3 16d3 16#c3 16b2 16#c3 8d3
  // 16b2 16#c3 16#d3 16#f3 16#c3 16d3 16#c3 16b2 8#c3 8b2

  // Nokia Composer Epic Sax
  // http://www.youtube.com/watch?v=hsX3wPawqZI
  // 8a1 8- 16a1 32a1 32a1 32g1 16a1 32- 8a1 8- 16a1 32a1 32a1 32g1 16a1 32-
  // 8a1 16- 8c2 8a1 8g1 16f1 16- 16d1 16d1 16e1 16f1 16d1
  rtttl.play(0);
}

function beep(when, freq, duration)
{
  squarewave.frequency.setValueAtTime(freq, when);

  songGain.gain.setValueAtTime(1, when);
  songGain.gain.setValueAtTime(0, when + duration);
}

function playMetronome(when, tempo, duration)
{
  // Tempo (BPM)
  // 4 beats per whole note, 60 seconds per minute
  var beatLength = 4.0 * 60.0 / tempo;
  var clickDuration = 0.005;
  var clickFrequency = 440;

  var then = when;
  while (then <= when + duration)
  {
    var noteDuration = beatLength / RTTTL.QUARTER_NOTE;
    beep(then, clickFrequency, clickDuration);
    then += noteDuration;
  }
}

function playNokia(when)
{
  //
  // Key
  //  C#
  //  F#
  //  G#
  // 8E6,8D6,4FS5,4GS5,8CS6,8B5,4D5,4E5,8B5,8A5,4CS5,4E5,2A5.
  // Tempo (BPM) = 220?
  // RTTTL:
  //  nokia:o=5,d=8,b=220:E6,D6,4F#,4G#,C#6,B,4D,4E,B,A,4C#,4E,2A.
  var beatLength = 4.0 * 60.0 / 220.0;

  var then = when;
  var duration;
  duration = beatLength / RTTTL.EIGHTH_NOTE;
  beep(then, RTTTL.NOTE_E6, duration);
  then += duration;
  duration = beatLength / RTTTL.EIGHTH_NOTE;
  beep(then, RTTTL.NOTE_D6, duration);
  then += duration;
  duration = beatLength / RTTTL.QUARTER_NOTE;
  beep(then, RTTTL.NOTE_FS5, duration);
  then += duration;
  duration = beatLength / RTTTL.QUARTER_NOTE;
  beep(then, RTTTL.NOTE_GS5, duration);
  then += duration;
  duration = beatLength / RTTTL.EIGHTH_NOTE;
  beep(then, RTTTL.NOTE_CS6, duration);
  then += duration;
  duration = beatLength / RTTTL.EIGHTH_NOTE;
  beep(then, RTTTL.NOTE_B5, duration);
  then += duration;
  duration = beatLength / RTTTL.QUARTER_NOTE;
  beep(then, RTTTL.NOTE_D5, duration);
  then += duration;
  duration = beatLength / RTTTL.QUARTER_NOTE;
  beep(then, RTTTL.NOTE_E5, duration);
  then += duration;
  duration = beatLength / RTTTL.EIGHTH_NOTE;
  beep(then, RTTTL.NOTE_B5, duration);
  then += duration;
  duration = beatLength / RTTTL.EIGHTH_NOTE;
  beep(then, RTTTL.NOTE_A5, duration);
  then += duration;
  duration = beatLength / RTTTL.QUARTER_NOTE;
  beep(then, RTTTL.NOTE_CS5, duration);
  then += duration;
  duration = beatLength / RTTTL.QUARTER_NOTE;
  beep(then, RTTTL.NOTE_E5, duration);
  then += duration;
  duration = beatLength / RTTTL.HALF_NOTE * RTTTL.DOT;
  beep(then, RTTTL.NOTE_A5, duration);
  then += duration;
}

function playScale(when)
{
  beep(when + 0, RTTTL.NOTE_A3, 0.1);
  beep(when + 0.5, RTTTL.NOTE_AS3, 0.1);
  beep(when + 1.0, RTTTL.NOTE_B3, 0.1);
  beep(when + 1.5, RTTTL.NOTE_C4, 0.1);
  beep(when + 2.0, RTTTL.NOTE_CS4, 0.1);
  beep(when + 2.5, RTTTL.NOTE_D4, 0.1);
  beep(when + 3.0, RTTTL.NOTE_DS4, 0.1);
  beep(when + 3.5, RTTTL.NOTE_E4, 0.1);
  beep(when + 4.0, RTTTL.NOTE_F4, 0.1);
  beep(when + 4.5, RTTTL.NOTE_FS4, 0.1);
  beep(when + 5.0, RTTTL.NOTE_G4, 0.1);
  beep(when + 5.5, RTTTL.NOTE_GS4, 0.1);
  beep(when + 6.0, RTTTL.NOTE_A4, 0.1);
  beep(when + 6.5, RTTTL.NOTE_AS4, 0.1);
  beep(when + 7.0, RTTTL.NOTE_B4, 0.1);
  beep(when + 7.5, RTTTL.NOTE_C5, 0.1);
  beep(when + 8.0, RTTTL.NOTE_CS5, 0.1);
  beep(when + 8.5, RTTTL.NOTE_D5, 0.1);
  beep(when + 9.0, RTTTL.NOTE_DS5, 0.1);
  beep(when + 9.5, RTTTL.NOTE_E5, 0.1);
  beep(when + 10.0, RTTTL.NOTE_F5, 0.1);
  beep(when + 10.5, RTTTL.NOTE_FS5, 0.1);
  beep(when + 11.0, RTTTL.NOTE_G5, 0.1);
  beep(when + 11.5, RTTTL.NOTE_GS5, 0.1);
  beep(when + 12.0, RTTTL.NOTE_A5, 0.1);
  beep(when + 12.5, RTTTL.NOTE_AS5, 0.1);
  beep(when + 13.0, RTTTL.NOTE_B5, 0.1);
  beep(when + 13.5, RTTTL.NOTE_C6, 0.1);
  beep(when + 14.0, RTTTL.NOTE_CS6, 0.1);
  beep(when + 14.5, RTTTL.NOTE_D6, 0.1);
  beep(when + 15.0, RTTTL.NOTE_DS6, 0.1);
  beep(when + 15.5, RTTTL.NOTE_E6, 0.1);
  beep(when + 16.0, RTTTL.NOTE_F6, 0.1);
  beep(when + 16.5, RTTTL.NOTE_FS6, 0.1);
  beep(when + 17.0, RTTTL.NOTE_G6, 0.1);
  beep(when + 17.5, RTTTL.NOTE_GS6, 0.1);
  beep(when + 18.0, RTTTL.NOTE_A6, 0.1);
  beep(when + 18.5, RTTTL.NOTE_AS6, 0.1);
  beep(when + 19.0, RTTTL.NOTE_B6, 0.1);
  beep(when + 19.5, RTTTL.NOTE_C7, 0.1);
  beep(when + 20.0, RTTTL.NOTE_CS7, 0.1);
  beep(when + 20.5, RTTTL.NOTE_D7, 0.1);
  beep(when + 21.0, RTTTL.NOTE_DS7, 0.1);
  beep(when + 21.5, RTTTL.NOTE_E7, 0.1);
  beep(when + 22.0, RTTTL.NOTE_F7, 0.1);
  beep(when + 22.5, RTTTL.NOTE_FS7, 0.1);
  beep(when + 23.0, RTTTL.NOTE_G7, 0.1);
  beep(when + 23.5, RTTTL.NOTE_GS7, 0.1);
  beep(when + 24.0, RTTTL.NOTE_A7, 0.1);
  beep(when + 24.5, RTTTL.NOTE_AS7, 0.1);
  beep(when + 25.0, RTTTL.NOTE_B7, 0.1);
}
</script>

</body>
</html>
